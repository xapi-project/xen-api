
(** This test verifies that the client and server functions generated by the
    IDL interoperate correctly *)

let test_call_core () =
  let server =
    let module Server = Test_common.Test_interface.Interface(Idl.GenServerExn ()) in
    Server.add (fun a b -> a + b);
    Server.sub (fun a b -> a - b);
    Server.mul (fun a b -> a * b);
    Server.div (fun a b -> a / b);
    Idl.server Server.implementation
  in
  let module Client = Test_common.Test_interface.Interface(Idl.GenClientExnRpc(struct let rpc = server end)) in
  Alcotest.(check int) "add" 4 (Client.add 1 3);
  Alcotest.(check int) "sub" 2 (Client.sub 3 1);
  Alcotest.(check int) "mul" 6 (Client.mul 2 3);
  Alcotest.(check int) "div" 4 (Client.div 8 2)

let tests =
  [ "test_call_core", `Quick, test_call_core
  ]
