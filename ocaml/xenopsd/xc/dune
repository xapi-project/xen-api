(library
 (name xenopsd_xc)
 (modules :standard \
          xenops_xc_main
          memory_breakdown
          memory_summary
          domain_sethandle
          cancel_utils_test)
 (libraries
  astring
  base64
  ezxenstore.core
  ezxenstore.watch
  fd-send-recv
  fmt
  forkexec
  inotify
  mtime
  mtime.clock.os
  polly
  re
  result
  rpclib.core
  rpclib.json
  rresult
  sexplib0
  qmp
  threads.posix
  uuid
  uuidm
  xapi-backtrace
  xapi-idl
  xapi-idl.memory
  xapi-idl.network
  xapi-idl.rrd
  xapi-idl.storage
  xapi-idl.storage.interface
  xapi-idl.guard.privileged
  xapi-idl.xen.interface
  xapi-idl.xen.interface.types
  xapi-log
  xapi-rrd
  xapi-stdext-date
  xapi-stdext-pervasives
  xapi-stdext-std
  xapi-stdext-threads
  xapi-stdext-unix
  xapi-xenopsd
  xapi-xenopsd.c_stubs
  xapi-xenopsd-xc.c_stubs
  xenctrl
  xenstore
  xenstore_transport.unix
 )

 (preprocess
  (pps ppx_deriving_rpc ppx_sexp_conv)
 )
 (wrapped false)
)
(executable
 (name xenops_xc_main)
 (modes exe)
 (public_name xenopsd-xc)
 (package xapi-xenopsd-xc)
 (modules xenops_xc_main)

 (libraries
  dune-build-info
  ezxenstore.core
  uuid
  xapi-idl
  xapi-idl.xen.interface
  xapi-inventory
  xapi-stdext-unix
  xapi-xenopsd
  xenctrl
  xenstore_transport.unix
  xenopsd_xc
 )
)

(executable
 (name memory_breakdown)
 (modes exe)
 (modules memory_breakdown)
 (libraries
  astring
  cmdliner
  dune-build-info
  ezxenstore.core
  uuid
  xapi-idl.memory
  xapi-stdext-date
  xapi-stdext-unix
  xenctrl
  xenopsd_xc
  xenstore_transport.unix
 )
)

(executable
 (name memory_summary)
 (modes exe)
 (modules memory_summary)
 (libraries
  dune-build-info
  xapi-stdext-date
  xapi-stdext-unix
  xapi-xenopsd
  xenctrl
 )
)

(executable
 (name domain_sethandle)
 (modes exe)
 (modules domain_sethandle)
 (libraries
  cmdliner
  ezxenstore
  xenctrl
 )
)

(executable
 (name cancel_utils_test)
 (modes exe)
 (modules cancel_utils_test)
 (libraries
  cmdliner
  dune-build-info
  ezxenstore.core
  threads.posix
  xapi-idl.xen.interface
  xapi-xenopsd
  xenctrl
  xenopsd_xc
  xenstore_transport.unix
 )

)
(rule
 (with-stdout-to
  xenopsd-xc.1
  (run %{dep:xenops_xc_main.exe} --help=groff)
 )
)

(rule
 (target xenopsd-xc.1.gz)
 (deps (:man xenopsd-xc.1))
 (action
   (with-stdout-to %{target} (with-stdin-from %{man} (run gzip))))
)

(install
 (section man)
 (files xenopsd-xc.1.gz)
 (package xapi-xenopsd-xc)
)
