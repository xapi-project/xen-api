(*
 * Copyright (C) Citrix Systems Inc.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published
 * by the Free Software Foundation; version 2.1 only. with the special
 * exception on linking described in file LICENSE.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *)
module D = Debug.Make (struct let name = "xapi_rate_limit" end)

module Bucket_table = Rate_limit.Bucket_table
module Key = Rate_limit.Bucket_table.Key

let bucket_table = Bucket_table.create ()

let submit_sync ~client_id ~callback amount =
  Bucket_table.submit_sync bucket_table ~client_id ~callback amount

let submit ~client_id ~callback amount =
  Bucket_table.submit bucket_table ~client_id ~callback amount

let peek ~client_id = Bucket_table.peek bucket_table ~client_id

let create ~__context ~user_agent ~host_ip ~burst_size ~fill_rate =
  if user_agent = "" && host_ip = "" then
    raise
      Api_errors.(
        Server_error
          (invalid_value, ["Expected user_agent or host_ip to be nonempty"])
      ) ;
  let client_id = Key.{user_agent; host_ip} in
  if Bucket_table.mem bucket_table ~client_id then
    raise
      Api_errors.(
        Server_error
          ( map_duplicate_key
          , ["user_agent"; user_agent; "user_agent already registered"]
          )
      ) ;
  let uuid = Uuidx.make () in
  let ref = Ref.make () in
  let add_bucket_succeeded =
    Bucket_table.add_bucket bucket_table ~client_id ~burst_size ~fill_rate
  in
  match add_bucket_succeeded with
  | true ->
      Db.Rate_limit.create ~__context ~ref ~uuid:(Uuidx.to_string uuid)
        ~user_agent ~host_ip ~burst_size ~fill_rate ;
      ref
  | false ->
      raise
        Api_errors.(
          Server_error
            ( invalid_value
            , [
                "fill_rate"
              ; string_of_float fill_rate
              ; "Fill rate cannot be 0 or negative"
              ]
            )
        )

let destroy ~__context ~self =
  let record = Db.Rate_limit.get_record ~__context ~self in
  let client_id =
    Key.
      {
        user_agent= record.rate_limit_user_agent
      ; host_ip= record.rate_limit_host_ip
      }
  in
  Bucket_table.delete_bucket bucket_table ~client_id ;
  Db.Rate_limit.destroy ~__context ~self

let register ~__context =
  List.iter
    (fun (_, bucket) ->
      let client_id =
        Key.
          {
            user_agent= bucket.API.rate_limit_user_agent
          ; host_ip= bucket.API.rate_limit_host_ip
          }
      in
      ignore
        (Bucket_table.add_bucket bucket_table ~client_id
           ~fill_rate:bucket.API.rate_limit_fill_rate
           ~burst_size:bucket.API.rate_limit_burst_size
        )
    )
    (Db.Rate_limit.get_all_records ~__context)

(* These are the average times taken by xapi to fulfil the requests *)
let token_costs =
  Hashtbl.of_seq
    (List.to_seq
       [
         ("VDI.pool_migrate", 257.909552)
       ; ("VM.migrate_send", 186.357493)
       ; ("host.apply_edition", 49.457409)
       ; ("VM.suspend", 44.825024)
       ; ("VM.resume_on", 43.383270)
       ; ("SR.probe", 41.225226)
       ; ("VM.copy", 32.585879)
       ; ("pool.enable_ha", 28.515320)
       ; ("VM.checkpoint", 23.014775)
       ; ("host.ha_join_liveset", 20.912049)
       ; ("Cluster.pool_create", 19.861666)
       ; ("VDI.copy", 19.146503)
       ; ("VM.pool_migrate", 16.976464)
       ; ("VM.resume", 16.593534)
       ; ("SR.destroy", 16.158883)
       ; ("Cluster_host.create", 15.364815)
       ; ("event.from", 13.125585)
       ; ("pool.management_reconfigure", 11.106379)
       ; ("pool.join", 9.706707)
       ; ("pool.disable_ha", 9.662020)
       ; ("host.prepare_for_poweroff", 9.493340)
       ; ("VM.set_memory_dynamic_range", 8.171569)
       ; ("host.evacuate", 7.635096)
       ; ("VM.clean_reboot", 6.922801)
       ; ("VM.restart_device_models", 6.726358)
       ; ("pool_update.apply", 6.677579)
       ; ("Bond.create", 6.063720)
       ; ("VM.clean_shutdown", 5.779665)
       ; ("VM.revert", 5.167195)
       ; ("host.install_server_certificate", 5.165420)
       ; ("pool.eject", 4.460441)
       ; ("Cluster.create", 4.424762)
       ; ("pool.sync_updates", 4.387346)
       ; ("host.apply_updates", 3.887800)
       ; ("SR.probe_ext", 3.778658)
       ; ("host.ha_wait_for_shutdown_via_statefile", 3.677161)
       ; ("pool_update.precheck", 3.306154)
       ; ("event.next", 3.253017)
       ; ("VDI.snapshot", 2.983962)
       ; ("pool_update.introduce", 2.753982)
       ; ("pool.enable_external_auth", 2.226998)
       ; ("VM.start_on", 2.190845)
       ; ("VM.hard_reboot", 2.139073)
       ; ("SR.create", 2.103516)
       ; ("VM.hard_shutdown", 2.066366)
       ; ("pool.designate_new_master", 1.967346)
       ; ("VM.start", 1.830110)
       ; ("VDI.clone", 1.712122)
       ; ("host.ha_release_resources", 1.646541)
       ; ("VM.snapshot", 1.459288)
       ; ("pool.is_slave", 1.445609)
       ; ("pool.recover_slaves", 1.427092)
       ; ("host.preconfigure_ha", 1.410345)
       ; ("pool_update.detach", 1.350796)
       ; ("pool_update.attach", 1.338446)
       ; ("host.update_master", 1.336511)
       ; ("PBD.plug", 1.267668)
       ; ("Repository.apply", 1.237862)
       ; ("pool.emergency_reset_master", 1.232223)
       ; ("VBD.plug", 1.144580)
       ; ("host.commit_new_master", 1.144527)
       ; ("SR.scan", 1.133962)
       ; ("host.enable_external_auth", 1.107988)
       ; ("VBD.unplug", 1.070053)
       ; ("pool_update.pool_clean", 1.044175)
       ; ("VM.clone", 1.019502)
       ; ("VM.provision", 0.981767)
       ; ("PIF.reconfigure_ip", 0.909502)
       ; ("pool.create_VLAN_from_PIF", 0.875542)
       ; ("pool.apply_edition", 0.829413)
       ; ("pool.disable_external_auth", 0.745834)
       ; ("VM.pool_migrate_complete", 0.742376)
       ; ("host.call_plugin", 0.741278)
       ; ("VLAN.create", 0.616747)
       ; ("VDI.create", 0.606362)
       ; ("host.update_firewalld_service_status", 0.579426)
       ; ("VDI.destroy", 0.550137)
       ; ("VIF.plug", 0.536839)
       ; ("host.set_iscsi_iqn", 0.487450)
       ; ("SR.update", 0.482580)
       ; ("VDI.resize", 0.437588)
       ; ("host.management_reconfigure", 0.369713)
       ; ("VIF.unplug", 0.340281)
       ; ("host.set_https_only", 0.337233)
       ; ("PIF.plug", 0.333846)
       ; ("host.disable_external_auth", 0.323262)
       ; ("VDI.set_name_label", 0.316701)
       ; ("VDI.set_name_description", 0.272491)
       ; ("PIF.scan", 0.264133)
       ; ("PBD.unplug", 0.254334)
       ; ("pool_update.resync_host", 0.215983)
       ; ("VDI.generate_config", 0.199678)
       ; ("PIF.reconfigure_ipv6", 0.192960)
       ; ("host.get_system_status_capabilities", 0.185781)
       ; ("host.request_backup", 0.179546)
       ; ("host.signal_networking_change", 0.178460)
       ; ("PIF.destroy", 0.175272)
       ; ("pool.enable_tls_verification", 0.160637)
       ; ("pool.set_repositories", 0.146938)
       ; ("pool.exchange_certificates_on_join", 0.138671)
       ; ("subject.create", 0.118591)
       ; ("host.shutdown_agent", 0.118081)
       ; ("VLAN.destroy", 0.116394)
       ; ("VM.unpause", 0.110404)
       ; ("session.change_password", 0.109895)
       ; ("host.syslog_reconfigure", 0.099574)
       ; ("pool.exchange_ca_certificates_on_join", 0.093144)
       ; ("pool.sync_database", 0.086285)
       ; ("VM.assert_can_migrate_sender", 0.077286)
       ; ("VM.pause", 0.074863)
       ; ("pool.hello", 0.072118)
       ; ("host.request_config_file_sync", 0.062448)
       ; ("network.attach_for_vm", 0.051612)
       ; ("host.migrate_receive", 0.051597)
       ; ("auth.get_subject_identifier", 0.044924)
       ; ("host.cert_distrib_atom", 0.042307)
       ; ("PBD.create", 0.035094)
       ; ("Repository.apply_livepatch", 0.028736)
       ; ("session.login_with_password", 0.027734)
       ; ("host.update_pool_secret", 0.027330)
       ; ("host.enable", 0.027242)
       ; ("host.get_data_sources", 0.026641)
       ; ("Observer.register", 0.025281)
       ; ("SR.forget", 0.021780)
       ; ("host.disable", 0.021741)
       ; ("Observer.set_attributes", 0.020536)
       ; ("VDI.get_all_records", 0.020524)
       ; ("host.set_multipathing", 0.019336)
       ; ("Observer.set_endpoints", 0.018160)
       ; ("Observer.create", 0.015905)
       ; ("Observer.set_enabled", 0.015219)
       ; ("host.reboot", 0.015137)
       ; ("VM.set_VCPUs_number_live", 0.014856)
       ; ("host.get_sm_diagnostics", 0.013681)
       ; ("host.set_license_params", 0.012687)
       ; ("role.get_all_records", 0.012687)
       ; ("host.apply_guest_agent_config", 0.010359)
       ; ("VM.atomic_set_resident_on", 0.009822)
       ; ("subject.destroy", 0.005524)
       ; ("message.get", 0.005002)
       ; ("PBD.destroy", 0.004741)
       ; ("host.get_diagnostic_timing_stats", 0.004670)
       ; ("VDI.get_all_records_where", 0.004475)
       ; ("host.write_uefi_certificates_to_disk", 0.004337)
       ; ("host.backup_rrds", 0.004214)
       ; ("VIF.create", 0.004065)
       ; ("session.slave_login", 0.003956)
       ; ("host.get_thread_diagnostics", 0.003906)
       ; ("host.enable_local_storage_caching", 0.003829)
       ; ("SR.get_data_sources", 0.003741)
       ; ("pool.add_repository", 0.003725)
       ; ("task.cancel", 0.003540)
       ; ("VM.set_NVRAM_EFI_variables", 0.003537)
       ; ("VBD.create", 0.003263)
       ; ("session.slave_local_login_with_password", 0.003192)
       ; ("VM.destroy", 0.003171)
       ; ("VDI.forget", 0.003090)
       ; ("SR.set_name_description", 0.002877)
       ; ("VBD.destroy", 0.002780)
       ; ("host.create", 0.002697)
       ; ("VM.query_data_source", 0.002616)
       ; ("PUSB.scan", 0.002592)
       ; ("VTPM.get_contents", 0.002470)
       ; ("pool.get_license_state", 0.002393)
       ; ("host.get_vms_which_prevent_evacuation", 0.002368)
       ; ("host.add_to_guest_VCPUs_params", 0.002341)
       ; ("VM.assert_can_boot_here", 0.002287)
       ; ("VM.set_memory_limits", 0.002266)
       ; ("VM.update_allowed_operations", 0.002096)
       ; ("VM.get_possible_hosts", 0.002050)
       ; ("VM.get_all_records_where", 0.002033)
       ; ("Diagnostics.db_stats", 0.002011)
       ; ("VM.set_actions_after_crash", 0.001944)
       ; ("VIF.destroy", 0.001822)
       ; ("VDI.db_forget", 0.001783)
       ; ("host.set_name_description", 0.001782)
       ; ("message.destroy_many", 0.001770)
       ; ("VM.create", 0.001747)
       ; ("host.tickle_heartbeat", 0.001734)
       ; ("VBD.eject", 0.001714)
       ; ("VGPU.atomic_set_resident_on", 0.001573)
       ; ("Diagnostics.network_stats", 0.001546)
       ; ("VM.get_all_records", 0.001503)
       ; ("event.inject", 0.001468)
       ; ("VM.set_VCPUs_max", 0.001436)
       ; ("pool.reset_telemetry_uuid", 0.001400)
       ; ("PBD.set_device_config", 0.001381)
       ; ("VTPM.set_contents", 0.001340)
       ; ("session.get_uuid", 0.001310)
       ; ("PIF.pool_introduce", 0.001294)
       ; ("host.allocate_resources_for_vm", 0.001254)
       ; ("host_cpu.get_all_records_where", 0.001248)
       ; ("VM.set_has_vendor_device", 0.001242)
       ; ("VBD.assert_attachable", 0.001226)
       ; ("VDI.set_cbt_enabled", 0.001149)
       ; ("message.create", 0.001136)
       ; ("VM.add_to_blocked_operations", 0.001111)
       ; ("host.set_crash_dump_sr", 0.001095)
       ; ("PCI.get_all_records", 0.001091)
       ; ("network.create", 0.001089)
       ; ("VGPU.create", 0.001088)
       ; ("VM.create_new_blob", 0.001077)
       ; ("VDI.db_introduce", 0.001069)
       ; ("VM.set_name_label", 0.001032)
       ; ("pool.set_ext_auth_cache_expiry", 0.001027)
       ; ("message.get_all_records_where", 0.001022)
       ; ("host.remove_from_license_server", 0.001021)
       ; ("VM.remove_from_blocked_operations", 0.000958)
       ; ("VTPM.create", 0.000923)
       ; ("host.sync_pif_currently_attached", 0.000922)
       ; ("host.add_to_logging", 0.000906)
       ; ("VM.set_is_default_template", 0.000900)
       ; ("host.add_to_license_server", 0.000897)
       ; ("VDI.read_database_pool_uuid", 0.000894)
       ; ("VM_metrics.get_all_records", 0.000883)
       ; ("host.remove_from_logging", 0.000880)
       ; ("VLAN.pool_introduce", 0.000864)
       ; ("Repository.introduce_bundle", 0.000863)
       ; ("Repository.introduce", 0.000863)
       ; ("host.set_license_server", 0.000827)
       ; ("host.set_suspend_image_sr", 0.000810)
       ; ("message.get_all_records", 0.000799)
       ; ("VM.get_HVM_boot_params", 0.000787)
       ; ("PGPU.set_GPU_group", 0.000767)
       ; ("host.compute_free_memory", 0.000764)
       ; ("SR.introduce", 0.000747)
       ; ("pool_update.destroy", 0.000725)
       ; ("host.add_to_other_config", 0.000709)
       ; ("VM.get_cooperative", 0.000696)
       ; ("VTPM.destroy", 0.000680)
       ; ("GPU_group.set_allocation_algorithm", 0.000669)
       ; ("host_metrics.get_all_records", 0.000669)
       ; ("VM.set_actions_after_shutdown", 0.000638)
       ; ("Repository.forget", 0.000621)
       ; ("pool.set_ext_auth_cache_size", 0.000615)
       ; ("blob.create", 0.000614)
       ; ("task.set_status", 0.000605)
       ; ("VM.set_other_config", 0.000596)
       ; ("pool.set_ext_auth_cache_enabled", 0.000592)
       ; ("host.get_tracked_user_agents", 0.000586)
       ; ("PIF.set_disallow_unplug", 0.000586)
       ; ("host.query_data_source", 0.000580)
       ; ("pool_update.get_all_records_where", 0.000560)
       ; ("pool.disable_repository_proxy", 0.000551)
       ; ("network.destroy", 0.000524)
       ; ("host.set_other_config", 0.000521)
       ; ("host.get_all_records", 0.000501)
       ; ("VDI.pool_introduce", 0.000481)
       ; ("pool.set_telemetry_next_collection", 0.000458)
       ; ("host.get_management_interface", 0.000445)
       ; ("VM.set_name_description", 0.000438)
       ; ("GPU_group.update_enabled_VGPU_types", 0.000435)
       ; ("pool.initial_auth", 0.000412)
       ; ("pool.set_default_SR", 0.000406)
       ; ("GPU_group.update_supported_VGPU_types", 0.000400)
       ; ("VM.add_to_other_config", 0.000397)
       ; ("VM.get_snapshots", 0.000385)
       ; ("VM.remove_from_platform", 0.000383)
       ; ("SM.get_all_records", 0.000380)
       ; ("host.get_all_records_where", 0.000378)
       ; ("network.pool_introduce", 0.000375)
       ; ("VM.remove_from_other_config", 0.000365)
       ; ("VM.set_VCPUs_at_startup", 0.000362)
       ; ("SR.get_all_records", 0.000360)
       ; ("secret.create", 0.000351)
       ; ("host_cpu.get_all_records", 0.000340)
       ; ("secret.destroy", 0.000337)
       ; ("VGPU_type.get_all_records_where", 0.000329)
       ; ("PIF.get_network", 0.000325)
       ; ("event.register", 0.000324)
       ; ("PGPU.get_by_uuid", 0.000322)
       ; ("PIF.get_all_records_where", 0.000321)
       ; ("VM.remove_from_HVM_boot_params", 0.000320)
       ; ("PBD.add_to_other_config", 0.000313)
       ; ("PIF.add_to_other_config", 0.000312)
       ; ("task.create", 0.000311)
       ; ("PBD.remove_from_other_config", 0.000310)
       ; ("pool.set_crash_dump_SR", 0.000308)
       ; ("pool.add_to_license_server", 0.000305)
       ; ("host.sync_vlans", 0.000303)
       ; ("subject.add_to_roles", 0.000303)
       ; ("VM.add_to_platform", 0.000296)
       ; ("VDI.get_by_name_label", 0.000291)
       ; ("pool.get_all_records_where", 0.000280)
       ; ("VM.add_to_HVM_boot_params", 0.000278)
       ; ("VM.set_suspend_SR", 0.000277)
       ; ("pool.set_suspend_image_SR", 0.000274)
       ; ("VDI.set_snapshot_of", 0.000271)
       ; ("host.get_record", 0.000270)
       ; ("network.add_to_other_config", 0.000269)
       ; ("PIF.get_all_records", 0.000264)
       ; ("network.remove_from_other_config", 0.000261)
       ; ("VM.set_HVM_boot_policy", 0.000260)
       ; ("VDI.add_to_sm_config", 0.000260)
       ; ("VDI.set_managed", 0.000256)
       ; ("task.destroy", 0.000250)
       ; ("pool.add_to_other_config", 0.000245)
       ; ("VBD.get_all_records", 0.000244)
       ; ("VM.set_is_a_template", 0.000236)
       ; ("VM.set_PV_args", 0.000232)
       ; ("VDI.remove_from_sm_config", 0.000230)
       ; ("SR.get_all_records_where", 0.000227)
       ; ("secret.introduce", 0.000225)
       ; ("VDI.set_sm_config", 0.000222)
       ; ("task.set_other_config", 0.000219)
       ; ("SR.set_other_config", 0.000217)
       ; ("host.set_ssl_legacy", 0.000214)
       ; ("pool.remove_from_other_config", 0.000211)
       ; ("SR.add_to_other_config", 0.000208)
       ; ("VM.get_record", 0.000206)
       ; ("pool.set_other_config", 0.000205)
       ; ("VDI.add_to_other_config", 0.000203)
       ; ("pool.get_all_records", 0.000200)
       ; ("pool.detect_nonhomogeneous_external_auth", 0.000197)
       ; ("SR.set_sm_config", 0.000196)
       ; ("network.set_MTU", 0.000194)
       ; ("SR.set_virtual_allocation", 0.000191)
       ; ("network.get_all_records", 0.000187)
       ; ("VM.get_allowed_VBD_devices", 0.000186)
       ; ("message.get_by_uuid", 0.000186)
       ; ("session.logout", 0.000182)
       ; ("VDI.set_physical_utilisation", 0.000180)
       ; ("pool.remove_from_license_server", 0.000178)
       ; ("host.sync_tunnels", 0.000171)
       ; ("SR.add_to_sm_config", 0.000168)
       ; ("VBD.add_to_other_config", 0.000168)
       ; ("host.emergency_clear_mandatory_guidance", 0.000167)
       ; ("PIF_metrics.get_all_records", 0.000164)
       ; ("PBD.get_by_uuid", 0.000163)
       ; ("task.get_all_records_where", 0.000163)
       ; ("pool.get_record", 0.000162)
       ; ("VIF.get_all_records", 0.000161)
       ; ("SM.add_to_other_config", 0.000161)
       ; ("SR.remove_from_sm_config", 0.000160)
       ; ("task.set_progress", 0.000160)
       ; ("VM.get_NVRAM", 0.000155)
       ; ("message.get_record", 0.000151)
       ; ("host.remove_from_other_config", 0.000151)
       ; ("event.unregister", 0.000141)
       ; ("VGPU.get_PCI", 0.000135)
       ; ("VM.get_by_name_label", 0.000135)
       ; ("PBD.get_all_records", 0.000134)
       ; ("SR.set_physical_utilisation", 0.000132)
       ; ("host.ha_xapi_healthcheck", 0.000132)
       ; ("VDI.set_virtual_size", 0.000131)
       ; ("Certificate.get_all_records", 0.000129)
       ; ("PGPU.get_all_records_where", 0.000128)
       ; ("VIF.get_all_records_where", 0.000125)
       ; ("session.slave_local_login", 0.000125)
       ; ("PBD.get_all", 0.000124)
       ; ("VBD.get_all_records_where", 0.000122)
       ; ("SR.set_physical_size", 0.000118)
       ; ("host.emergency_ha_disable", 0.000117)
       ; ("VDI.set_read_only", 0.000117)
       ; ("network.get_all_records_where", 0.000114)
       ; ("task.get_record", 0.000113)
       ; ("pool.get_suspend_image_SR", 0.000112)
       ; ("VLAN.get_by_uuid", 0.000111)
       ; ("SM.get_all_records_where", 0.000110)
       ; ("network.get_name_label", 0.000110)
       ; ("SM.remove_from_other_config", 0.000110)
       ; ("VDI.remove_from_other_config", 0.000106)
       ; ("VM.get_VBDs", 0.000105)
       ; ("blob.get_record", 0.000104)
       ; ("task.get_name_label", 0.000104)
       ; ("VM_guest_metrics.get_all_records", 0.000102)
       ; ("task.get_all_records", 0.000101)
       ; ("VDI.get_uuid", 0.000101)
       ; ("SR.get_record", 0.000099)
       ; ("PBD.get_all_records_where", 0.000099)
       ; ("pool.get_policy_no_vendor_device", 0.000098)
       ; ("secret.set_value", 0.000097)
       ; ("VBD.get_record", 0.000095)
       ; ("blob.get_all_records", 0.000094)
       ; ("host.get_external_auth_type", 0.000094)
       ; ("SDN_controller.get_all_records", 0.000093)
       ; ("VIF.get_record", 0.000092)
       ; ("secret.get_all_records", 0.000092)
       ; ("host.propose_new_master", 0.000087)
       ; ("console.get_record", 0.000087)
       ; ("PIF.get_record", 0.000086)
       ; ("pool.get_other_config", 0.000086)
       ; ("VM_guest_metrics.get_record", 0.000086)
       ; ("PIF.get_all_where", 0.000085)
       ; ("VM_metrics.get_record", 0.000084)
       ; ("pool_patch.get_all_records", 0.000083)
       ; ("VLAN.get_all_records_where", 0.000083)
       ; ("session.get_is_local_superuser", 0.000081)
       ; ("task.get_progress", 0.000081)
       ; ("Repository.get_by_name_label", 0.000081)
       ; ("VBD.get_VDI", 0.000081)
       ; ("VBD.get_mode", 0.000081)
       ; ("SR.get_VDIs", 0.000079)
       ; ("host.is_in_emergency_mode", 0.000079)
       ; ("host_crashdump.get_all_records_where", 0.000078)
       ; ("host_metrics.get_record", 0.000077)
       ; ("Repository.get_all_records_where", 0.000077)
       ; ("host.get_ssh_enabled", 0.000076)
       ; ("Bond.get_all_records_where", 0.000076)
       ; ("VM.get_all", 0.000076)
       ; ("pool_update.get_record", 0.000075)
       ; ("host.get_capabilities", 0.000075)
       ; ("task.get_created", 0.000074)
       ; ("VM.get_VIFs", 0.000073)
       ; ("VM.get_allowed_VIF_devices", 0.000073)
       ; ("VM.get_other_config", 0.000073)
       ; ("pool.get_tls_verification_enabled", 0.000072)
       ; ("host.set_name_label", 0.000071)
       ; ("PBD.get_all_where", 0.000071)
       ; ("Cluster.get_all_records_where", 0.000070)
       ; ("console.get_all_records", 0.000070)
       ; ("VM.get_allowed_operations", 0.000070)
       ; ("VM.get_recommendations", 0.000070)
       ; ("session.get_rbac_permissions", 0.000069)
       ; ("Repository.get_by_uuid", 0.000069)
       ; ("task.get_uuid", 0.000069)
       ; ("network_sriov.get_all_records_where", 0.000068)
       ; ("host.get_all_where", 0.000068)
       ; ("PUSB.get_all_records", 0.000068)
       ; ("VBD.get_userdevice", 0.000068)
       ; ("VDI.get_managed", 0.000068)
       ; ("pool.get_default_SR", 0.000067)
       ; ("host.get_supported_bootloaders", 0.000067)
       ; ("VBD.get_other_config", 0.000067)
       ; ("VBD.get_by_uuid", 0.000066)
       ; ("VGPU.get_all", 0.000066)
       ; ("GPU_group.get_all_records", 0.000066)
       ; ("PGPU.get_all_records", 0.000066)
       ; ("PIF.get_by_uuid", 0.000065)
       ; ("network.get_record", 0.000064)
       ; ("Repository.get_record", 0.000064)
       ; ("host.get_PBDs", 0.000063)
       ; ("VDI.get_is_a_snapshot", 0.000062)
       ; ("SR.get_all", 0.000062)
       ; ("PBD.get_record", 0.000062)
       ; ("VM.get_name_label", 0.000062)
       ; ("GPU_group.get_all_records_where", 0.000062)
       ; ("SR.get_by_name_label", 0.000061)
       ; ("VMSS.get_all_records", 0.000060)
       ; ("network.get_by_name_label", 0.000060)
       ; ("pool.get_all", 0.000059)
       ; ("Bond.get_record", 0.000059)
       ; ("network.get_bridge", 0.000059)
       ; ("SR.get_PBDs", 0.000059)
       ; ("pool_patch.get_all_records_where", 0.000057)
       ; ("VIF.get_by_uuid", 0.000057)
       ; ("pool.get_by_uuid", 0.000056)
       ; ("Cluster.get_uuid", 0.000056)
       ; ("VM.get_is_a_snapshot", 0.000056)
       ; ("host.get_other_config", 0.000056)
       ; ("VM.get_uuid", 0.000055)
       ; ("VM.get_name_description", 0.000055)
       ; ("Cluster.get_all", 0.000055)
       ; ("PBD.get_SR", 0.000054)
       ; ("DR_task.get_all_records", 0.000054)
       ; ("host.get_license_params", 0.000054)
       ; ("VMSS.get_all", 0.000053)
       ; ("PBD.get_host", 0.000053)
       ; ("network.get_PIFs", 0.000053)
       ; ("Bond.get_by_uuid", 0.000053)
       ; ("VM.get_by_uuid", 0.000053)
       ; ("VDI.get_record", 0.000052)
       ; ("host.get_by_uuid", 0.000052)
       ; ("VUSB.get_all_records", 0.000052)
       ; ("VM.get_suspend_VDI", 0.000052)
       ; ("PIF_metrics.get_record", 0.000052)
       ; ("host.get_API_version_minor", 0.000051)
       ; ("VDI.get_metadata_of_pool", 0.000051)
       ; ("PCI.get_pci_id", 0.000051)
       ; ("task.get_result", 0.000051)
       ; ("VDI.get_by_uuid", 0.000051)
       ; ("VDI.get_sm_config", 0.000051)
       ; ("network.get_by_uuid", 0.000050)
       ; ("VBD.get_device", 0.000050)
       ; ("host.get_name_label", 0.000050)
       ; ("PVS_cache_storage.get_all_records", 0.000050)
       ; ("VM.get_is_a_template", 0.000050)
       ; ("VLAN.get_record", 0.000049)
       ; ("VDI.get_on_boot", 0.000049)
       ; ("SR.get_virtual_allocation", 0.000049)
       ; ("SR.get_by_uuid", 0.000049)
       ; ("VBD.get_type", 0.000048)
       ; ("SM.get_by_name_label", 0.000048)
       ; ("VIF.get_device", 0.000048)
       ; ("Certificate.get_all_records_where", 0.000048)
       ; ("Observer.get_by_uuid", 0.000048)
       ; ("Feature.get_all_records", 0.000048)
       ; ("pool_update.get_all_records", 0.000048)
       ; ("host.get_PGPUs", 0.000048)
       ; ("SR.get_sm_config", 0.000048)
       ; ("host_cpu.get_record", 0.000048)
       ; ("VBD.get_uuid", 0.000047)
       ; ("host.get_virtual_hardware_platform_versions", 0.000047)
       ; ("pool.get_ha_enabled", 0.000047)
       ; ("host.get_editions", 0.000046)
       ; ("VM.get_memory_static_max", 0.000046)
       ; ("VGPU.get_all_records", 0.000046)
       ; ("host.get_API_version_major", 0.000046)
       ; ("SDN_controller.get_all", 0.000046)
       ; ("PBD.get_other_config", 0.000046)
       ; ("host.get_cpu_info", 0.000046)
       ; ("network.get_MTU", 0.000045)
       ; ("VM.get_VGPUs", 0.000045)
       ; ("host.get_all", 0.000045)
       ; ("VLAN.get_all_records", 0.000045)
       ; ("Repository.get_uuid", 0.000045)
       ; ("VDI.get_location", 0.000045)
       ; ("host.get_uuid", 0.000045)
       ; ("network.get_all", 0.000044)
       ; ("VGPU.get_all_records_where", 0.000044)
       ; ("session.get_this_host", 0.000044)
       ; ("host_patch.get_all_records", 0.000044)
       ; ("SR.get_other_config", 0.000043)
       ; ("host.get_software_version", 0.000043)
       ; ("pool.get_telemetry_next_collection", 0.000043)
       ; ("Bond.get_uuid", 0.000043)
       ; ("Observer.get_all_records", 0.000043)
       ; ("secret.get_by_uuid", 0.000043)
       ; ("VDI.get_name_label", 0.000043)
       ; ("pool_update.get_by_uuid", 0.000042)
       ; ("SR.get_type", 0.000042)
       ; ("VIF.get_uuid", 0.000042)
       ; ("SM.get_record", 0.000041)
       ; ("SM.get_driver_filename", 0.000041)
       ; ("Cluster_host.get_all", 0.000041)
       ; ("subject.get_record", 0.000041)
       ; ("pool.get_master", 0.000040)
       ; ("VDI.get_name_description", 0.000040)
       ; ("task.get_status", 0.000040)
       ; ("VTPM.get_by_uuid", 0.000040)
       ; ("host.get_external_auth_service_name", 0.000040)
       ; ("VDI.get_SR", 0.000040)
       ; ("pool.get_custom_uefi_certificates", 0.000040)
       ; ("host.get_pending_guidances", 0.000040)
       ; ("host.get_suspend_image_sr", 0.000040)
       ; ("host.get_ssh_enabled_timeout", 0.000040)
       ; ("VLAN.get_untagged_PIF", 0.000039)
       ; ("PBD.get_device_config", 0.000039)
       ; ("task.get_other_config", 0.000039)
       ; ("VDI.get_other_config", 0.000039)
       ; ("network.get_uuid", 0.000039)
       ; ("SR.get_uuid", 0.000039)
       ; ("host.get_bios_strings", 0.000039)
       ; ("pool.get_uefi_certificates", 0.000039)
       ; ("VM.get_power_state", 0.000039)
       ; ("Bond.get_all_records", 0.000039)
       ; ("pool_update.get_uuid", 0.000039)
       ; ("pool.get_cpu_info", 0.000039)
       ; ("pool.get_name_label", 0.000039)
       ; ("pool.get_current_operations", 0.000039)
       ; ("host.get_enabled", 0.000038)
       ; ("PBD.get_currently_attached", 0.000038)
       ; ("PIF.get_primary_address_type", 0.000038)
       ; ("PIF.get_VLAN", 0.000038)
       ; ("host.get_updates", 0.000037)
       ; ("SR.get_name_label", 0.000037)
       ; ("host.get_console_idle_timeout", 0.000037)
       ; ("VM.get_VTPMs", 0.000037)
       ; ("GPU_group.get_record", 0.000037)
       ; ("VDI.get_allow_caching", 0.000036)
       ; ("VDI.get_snapshot_time", 0.000036)
       ; ("host.get_ssh_auto_mode", 0.000036)
       ; ("host.get_address", 0.000036)
       ; ("PGPU.get_record", 0.000036)
       ; ("role.get_by_name_label", 0.000036)
       ; ("pool.get_license_server", 0.000035)
       ; ("VIF.get_network", 0.000035)
       ; ("VGPU_type.get_all_records", 0.000035)
       ; ("network.get_VIFs", 0.000035)
       ; ("VGPU_type.get_record", 0.000035)
       ; ("VDI.get_type", 0.000035)
       ; ("SR.get_content_type", 0.000034)
       ; ("PGPU.get_PCI", 0.000034)
       ; ("Cluster_host.get_all_records", 0.000034)
       ; ("Cluster.get_all_records", 0.000034)
       ; ("crashdump.get_all_records", 0.000034)
       ; ("PIF.get_uuid", 0.000034)
       ; ("secret.get_value", 0.000034)
       ; ("SR.get_name_description", 0.000034)
       ; ("VM.get_domid", 0.000034)
       ; ("host.get_license_server", 0.000034)
       ; ("PVS_proxy.get_all_records", 0.000033)
       ; ("pool.get_uuid", 0.000033)
       ; ("Repository.get_all_records", 0.000033)
       ; ("VGPU.get_scheduled_to_be_resident_on", 0.000033)
       ; ("network_sriov.get_all_records", 0.000033)
       ; ("Observer.get_uuid", 0.000032)
       ; ("task.get_error_info", 0.000032)
       ; ("tunnel.get_all_records", 0.000032)
       ; ("pool.get_vswitch_controller", 0.000032)
       ; ("VM_group.get_all_records", 0.000031)
       ; ("VM_appliance.get_all_records", 0.000031)
       ; ("PCI.get_record", 0.000030)
       ; ("VGPU.get_device", 0.000030)
       ; ("host_crashdump.get_all_records", 0.000030)
       ; ("subject.get_all_records", 0.000030)
       ; ("VTPM.get_all_records", 0.000029)
       ; ("USB_group.get_all_records", 0.000029)
       ; ("pool_update.get_name_label", 0.000029)
       ; ("pool_update.get_vdi", 0.000029)
       ; ("VGPU_type.get_by_uuid", 0.000028)
       ; ("VBD.get_empty", 0.000028)
       ; ("VGPU.get_record", 0.000027)
       ; ("VGPU.get_by_uuid", 0.000026)
       ; ("subject.get_all", 0.000026)
       ; ("VM.get_suspend_SR", 0.000025)
       ; ("GPU_group.get_by_uuid", 0.000025)
       ; ("subject.get_all_records_where", 0.000025)
       ; ("session.local_logout", 0.000025)
       ; ("PVS_server.get_all_records", 0.000024)
       ; ("PVS_site.get_all_records", 0.000024)
       ; ("subject.get_uuid", 0.000023)
       ; ("secret.get_uuid", 0.000023)
       ; ("VGPU.get_uuid", 0.000023)
       ; ("VTPM.get_record", 0.000023)
       ; ("subject.get_by_uuid", 0.000022)
       ; ("VTPM.get_all_records_where", 0.000022)
       ; ("VM.get_is_control_domain", 0.000021)
       ; ("pool_update.get_installation_size", 0.000021)
       ; ("VGPU_type.get_model_name", 0.000020)
       ; ("task.get_backtrace", 0.000018)
       ; ("VTPM.get_uuid", 0.000017)
       ; ("PBD.get_uuid", 0.000017)
       ]
    )

let median_token_cost =
  let arr = Hashtbl.to_seq_values token_costs |> Array.of_seq in
  let n = Array.length arr in
  if n = 0 then
    0.
  else (
    Array.sort Float.compare arr ;
    if n mod 2 = 1 then
      arr.(n / 2)
    else
      (arr.((n / 2) - 1) +. arr.(n / 2)) /. 2.0
  )

let get_token_cost name =
  let amount = Hashtbl.find_opt token_costs name in
  Option.value ~default:median_token_cost amount
