OCAMLINCLUDES = $(ROOT)/ocaml $(ROOT)/ocaml/autogen interface \
	$(ROOT)/ocaml/xapi $(ROOT)/ocaml/idl $(ROOT)/ocaml/idl/ocaml_backend
# ocaml/xapi only needed for xapi_fist : should move xapi_first to libs
OCAMLPACKS    = xml-light2 stunnel http-svr xenctrl
OCAML_LIBS    = $(ROOT)/ocaml/fhs ../idl/ocaml_backend/xapi_client

UseCamlp4(rpc-light.syntax, rrdd_server)

RRDD_SERVER = rrdd_server
RRDD_SERVER_FILES = rrdd_main interface/rrdd_interface interface/data_source \
	interface/rrd interface/ds rrdd_server ../xapi/xapi_fist
RRDD_TEST = rrdd_test
RRDD_TEST_FILES = rrdd_test interface/rrdd_interface interface/data_source

.SUBDIRS: interface

OCamlProgram($(RRDD_SERVER), $(RRDD_SERVER_FILES))
OCamlDocProgram($(RRDD_SERVER), $(RRDD_SERVER_FILES))
OCamlProgram($(RRDD_TEST), $(RRDD_TEST_FILES))

.PHONY: test
test: $(RRDD_SERVER) $(RRDD_TEST)
	killall $(RRDD_SERVER) || true
	./$(RRDD_SERVER) -daemon
	./$(RRDD_TEST)
	killall $(RRDD_SERVER) || true

.PHONY: clean
clean:
	rm -f *.cmi *.cmx *.cmo *.a *.cma *.run *.opt *.annot *.o *.orig *.spit *.spot *.omc
	rm -f $(RRDD_SERVER) $(RRDD_TEST)
